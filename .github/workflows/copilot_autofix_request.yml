name: Copilot Autofix Request

on:
  workflow_run:
    workflows: ["Build"]   # Debe coincidir con: name: Build (en tu build.yml)
    types: [completed]

permissions:
  actions: read
  pull-requests: write
  issues: write
  contents: read

jobs:
  request-copilot-fix:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Post autofix request to PR(s)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const run = context.payload.workflow_run;
            const runId = run.id;
            const runUrl = run.html_url;
            const headBranch = run.head_branch;
            const headSha = run.head_sha;

            core.info(`Processing workflow run ${runId} for branch ${headBranch} (${headSha})`);

            const prs = run.pull_requests || [];
            if (prs.length === 0) {
              core.info("No PRs associated with this workflow_run. Exiting.");
              return;
            }

            core.info(`Found ${prs.length} PR(s) associated with this run`);

            // Traer jobs del workflow_run y resumir fallas
            let jobsResp;
            try {
              jobsResp = await github.rest.actions.listJobsForWorkflowRun({
                owner,
                repo,
                run_id: runId,
                per_page: 100,
              });
            } catch (error) {
              core.warning(`Failed to list jobs: ${error.message}`);
              jobsResp = { data: { jobs: [] } };
            }

            const failedJobs = (jobsResp.data.jobs || [])
              .filter(j => j.conclusion === "failure" || j.conclusion === "cancelled" || j.conclusion === "timed_out")
              .map(j => ({
                name: j.name,
                conclusion: j.conclusion,
                url: j.html_url,
                started_at: j.started_at,
                completed_at: j.completed_at
              }));

            core.info(`Found ${failedJobs.length} failed job(s)`);

            const marker = `<!-- copilot-autofix:${runId} -->`;

            for (const pr of prs) {
              const issue_number = pr.number;
              core.info(`Processing PR #${issue_number}`);

              // Evitar comentar 2 veces por el mismo run
              let comments;
              try {
                comments = await github.rest.issues.listComments({
                  owner,
                  repo,
                  issue_number,
                  per_page: 100,
                });
              } catch (error) {
                core.error(`Failed to list comments for PR #${issue_number}: ${error.message}`);
                continue;
              }

              const already = comments.data.some(c => (c.body || "").includes(marker));
              if (already) {
                core.info(`PR #${issue_number}: comment already exists for run ${runId}. Skipping.`);
                continue;
              }

              const failedList = failedJobs.length
                ? failedJobs.map(j => `- **${j.name}** (${j.conclusion}) ‚Äî [Ver logs](${j.url})`).join("\n")
                : "- (No se pudieron listar jobs fallidos; revisa el run.)";

              // Obtener informaci√≥n adicional del PR
              let prDetails;
              try {
                prDetails = await github.rest.pulls.get({
                  owner,
                  repo,
                  pull_number: issue_number,
                });
              } catch (error) {
                core.warning(`Could not fetch PR details: ${error.message}`);
                prDetails = null;
              }

              const prInfo = prDetails ? `
            **Informaci√≥n del PR:**
            - Branch: \`${prDetails.data.head.ref}\`
            - Commit: \`${headSha.substring(0, 7)}\`
            - Archivos modificados: ${prDetails.data.changed_files}
            - L√≠neas a√±adidas: +${prDetails.data.additions} / L√≠neas eliminadas: -${prDetails.data.deletions}
            ` : '';

              const body = `${marker}
            @copilot

            üî¥ **Los checks de CI fallaron** en el workflow [${run.name}](${runUrl})

            **Por favor, ay√∫dame a:**
            1. **Analizar los logs de los jobs fallidos** para identificar la causa ra√≠z
            2. **Corregir el error** de forma quir√∫rgica (cambios m√≠nimos necesarios)
            3. **Validar la soluci√≥n** y agregar/ajustar tests si es necesario
            4. **Hacer commit y push** de los cambios a esta misma rama del PR

            **Workflow run:** ${runUrl}

            **Jobs fallidos:**
            ${failedList}
            ${prInfo}
            **Contexto adicional:**
            - ‚ùå No deshabilites checks ni ignores warnings/errores
            - ‚úÖ Mant√©n cambios m√≠nimos y enfocados en el problema
            - ‚úÖ Aseg√∫rate de que la soluci√≥n no rompa funcionalidad existente
            - ‚úÖ Agrega comentarios solo si son necesarios para explicar l√≥gica compleja

            <details>
            <summary>üìã Instrucciones detalladas</summary>

            1. **Analiza los logs**: Haz clic en los links de los jobs fallidos arriba
            2. **Identifica el error**: Busca mensajes de error, stack traces, o warnings
            3. **Reproduce localmente** (si es posible): \`git checkout ${headBranch}\`
            4. **Implementa la correcci√≥n**: Edita solo los archivos necesarios
            5. **Valida**: Ejecuta build/tests localmente si es posible
            6. **Commit y push**: Los cambios deben ir a la rama \`${headBranch}\`

            </details>
            `;

              try {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body,
                });
                core.info(`‚úÖ Posted @copilot autofix request to PR #${issue_number}`);
              } catch (error) {
                core.error(`‚ùå Failed to post comment to PR #${issue_number}: ${error.message}`);
              }
            }

            core.info("Autofix request workflow completed successfully");
